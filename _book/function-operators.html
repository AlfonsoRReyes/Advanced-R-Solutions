<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Advanced R Solutions</title>
  <meta name="description" content="Solutions to the exercises in Hadley Wickham’s book Advanced R.">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="Advanced R Solutions" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/advrs_cover.png" />
  <meta property="og:description" content="Solutions to the exercises in Hadley Wickham’s book Advanced R." />
  <meta name="github-repo" content="Tazinho/Advanced-R-Solutions" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Advanced R Solutions" />
  
  <meta name="twitter:description" content="Solutions to the exercises in Hadley Wickham’s book Advanced R." />
  <meta name="twitter:image" content="images/advrs_cover.png" />

<meta name="author" content="Malte Grosser, Henning Bumann, Peter Hurford &amp; Robert Krzyzanowski">


<meta name="date" content="2017-07-20">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="functionals.html">
<link rel="next" href="non-standard-evaluation.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- COLLAPSIBLE TEXT WITH OPEN ALL/CLOSE ALL LINK -->

<!-- This goes into the HEAD of the html file -->

<script language="JavaScript" type="text/javascript">
<!-- Copyright 2007, Sandeep Gangadharan -->
<!-- For more free scripts go to http://www.sivamdesign.com/scripts/ -->
<!--
if (document.getElementById) {
 document.write('<style type="text/css">.texter {display:none; border-left:white 20px solid; color:#404040; font-family:verdana,arial,helvetica,sans-serif; font-size:9pt} @media print {.texter {display:block;}}</style>') }

 var divNum = new Array("a1","a2","a3");  // at the left you should add a1, a2 etc. for each header you wish to include
                                          // so if you want 4 headers you should add a1, a2, a3, a4 in the format shown
                                          // enclosed in double quotes
function openClose(theID) {
 for(var i=0; i < divNum.length; i++) {
  if (divNum[i] == theID) {
   if (document.getElementById(divNum[i]).style.display == "block") { document.getElementById(divNum[i]).style.display = "none" }
   else { document.getElementById(divNum[i]).style.display = "block" }
  }
  else { document.getElementById(divNum[i]).style.display = "none"; }
 }
}

function openAll() {
 for(var i=0; i < divNum.length; i++) {
   document.getElementById(divNum[i]).style.display = "block";
 }
}

function closeAll() {
 for(var i=0; i < divNum.length; i++) {
   document.getElementById(divNum[i]).style.display = "none";
 }
}
// -->
</script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1" data-path="data-structures.html"><a href="data-structures.html"><i class="fa fa-check"></i><b>1</b> Data structures</a><ul>
<li class="chapter" data-level="1.1" data-path="data-structures.html"><a href="data-structures.html#vectors"><i class="fa fa-check"></i><b>1.1</b> Vectors</a></li>
<li class="chapter" data-level="1.2" data-path="data-structures.html"><a href="data-structures.html#attributes"><i class="fa fa-check"></i><b>1.2</b> Attributes</a></li>
<li class="chapter" data-level="1.3" data-path="data-structures.html"><a href="data-structures.html#matrices-and-arrays"><i class="fa fa-check"></i><b>1.3</b> Matrices and arrays</a></li>
<li class="chapter" data-level="1.4" data-path="data-structures.html"><a href="data-structures.html#data-frames"><i class="fa fa-check"></i><b>1.4</b> Data frames</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="subsetting.html"><a href="subsetting.html"><i class="fa fa-check"></i><b>2</b> Subsetting</a><ul>
<li class="chapter" data-level="2.1" data-path="subsetting.html"><a href="subsetting.html#data-types"><i class="fa fa-check"></i><b>2.1</b> Data types</a></li>
<li class="chapter" data-level="2.2" data-path="subsetting.html"><a href="subsetting.html#subsetting-operators"><i class="fa fa-check"></i><b>2.2</b> Subsetting operators</a></li>
<li class="chapter" data-level="2.3" data-path="subsetting.html"><a href="subsetting.html#applications"><i class="fa fa-check"></i><b>2.3</b> Applications</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>3</b> Functions</a><ul>
<li class="chapter" data-level="3.1" data-path="functions.html"><a href="functions.html#function-components"><i class="fa fa-check"></i><b>3.1</b> Function components</a></li>
<li class="chapter" data-level="3.2" data-path="functions.html"><a href="functions.html#lexical-scoping"><i class="fa fa-check"></i><b>3.2</b> Lexical Scoping</a></li>
<li class="chapter" data-level="3.3" data-path="functions.html"><a href="functions.html#function-arguments"><i class="fa fa-check"></i><b>3.3</b> Function arguments</a></li>
<li class="chapter" data-level="3.4" data-path="functions.html"><a href="functions.html#special-calls"><i class="fa fa-check"></i><b>3.4</b> Special calls</a></li>
<li class="chapter" data-level="3.5" data-path="functions.html"><a href="functions.html#return-values"><i class="fa fa-check"></i><b>3.5</b> Return Values</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="oo-field-guide.html"><a href="oo-field-guide.html"><i class="fa fa-check"></i><b>4</b> OO field guide</a><ul>
<li class="chapter" data-level="4.1" data-path="oo-field-guide.html"><a href="oo-field-guide.html#s3"><i class="fa fa-check"></i><b>4.1</b> S3</a></li>
<li class="chapter" data-level="4.2" data-path="oo-field-guide.html"><a href="oo-field-guide.html#s4"><i class="fa fa-check"></i><b>4.2</b> S4</a></li>
<li class="chapter" data-level="4.3" data-path="oo-field-guide.html"><a href="oo-field-guide.html#rc"><i class="fa fa-check"></i><b>4.3</b> RC</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="environments.html"><a href="environments.html"><i class="fa fa-check"></i><b>5</b> Environments</a><ul>
<li class="chapter" data-level="5.1" data-path="environments.html"><a href="environments.html#environment-basics"><i class="fa fa-check"></i><b>5.1</b> Environment basics</a></li>
<li class="chapter" data-level="5.2" data-path="environments.html"><a href="environments.html#recursing-over-environments"><i class="fa fa-check"></i><b>5.2</b> Recursing over environments</a></li>
<li class="chapter" data-level="5.3" data-path="environments.html"><a href="environments.html#function-environments"><i class="fa fa-check"></i><b>5.3</b> Function environments</a></li>
<li class="chapter" data-level="5.4" data-path="environments.html"><a href="environments.html#binding-names-to-values"><i class="fa fa-check"></i><b>5.4</b> Binding names to values</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="exceptions-and-debugging.html"><a href="exceptions-and-debugging.html"><i class="fa fa-check"></i><b>6</b> Exceptions and debugging</a><ul>
<li class="chapter" data-level="6.1" data-path="exceptions-and-debugging.html"><a href="exceptions-and-debugging.html#condition-handling"><i class="fa fa-check"></i><b>6.1</b> Condition handling</a></li>
<li class="chapter" data-level="6.2" data-path="exceptions-and-debugging.html"><a href="exceptions-and-debugging.html#defensive-programming"><i class="fa fa-check"></i><b>6.2</b> Defensive programming</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="functional-programming.html"><a href="functional-programming.html"><i class="fa fa-check"></i><b>7</b> Functional programming</a><ul>
<li class="chapter" data-level="7.1" data-path="functional-programming.html"><a href="functional-programming.html#annonymous-functions"><i class="fa fa-check"></i><b>7.1</b> Annonymous functions</a></li>
<li class="chapter" data-level="7.2" data-path="functional-programming.html"><a href="functional-programming.html#closures"><i class="fa fa-check"></i><b>7.2</b> Closures</a></li>
<li class="chapter" data-level="7.3" data-path="functional-programming.html"><a href="functional-programming.html#lists-of-functions"><i class="fa fa-check"></i><b>7.3</b> Lists of functions</a></li>
<li class="chapter" data-level="7.4" data-path="functional-programming.html"><a href="functional-programming.html#case-study-numerical-integration"><i class="fa fa-check"></i><b>7.4</b> Case study: numerical integration</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="functionals.html"><a href="functionals.html"><i class="fa fa-check"></i><b>8</b> Functionals</a><ul>
<li class="chapter" data-level="8.1" data-path="functionals.html"><a href="functionals.html#my-first-functional-lapply"><i class="fa fa-check"></i><b>8.1</b> My first functional: lapply()</a></li>
<li class="chapter" data-level="8.2" data-path="functionals.html"><a href="functionals.html#for-loops-functionals-friends-of-lapply"><i class="fa fa-check"></i><b>8.2</b> For loops functionals: friends of lapply():</a></li>
<li class="chapter" data-level="8.3" data-path="functionals.html"><a href="functionals.html#manipulating-matrices-and-data-frames"><i class="fa fa-check"></i><b>8.3</b> Manipulating matrices and data frames</a></li>
<li class="chapter" data-level="8.4" data-path="functionals.html"><a href="functionals.html#manipulating-lists"><i class="fa fa-check"></i><b>8.4</b> Manipulating lists</a></li>
<li class="chapter" data-level="8.5" data-path="functionals.html"><a href="functionals.html#mathematical-functionals"><i class="fa fa-check"></i><b>8.5</b> Mathematical functionals</a></li>
<li class="chapter" data-level="8.6" data-path="functionals.html"><a href="functionals.html#a-family-of-functions"><i class="fa fa-check"></i><b>8.6</b> A family of functions</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="function-operators.html"><a href="function-operators.html"><i class="fa fa-check"></i><b>9</b> Function operators</a><ul>
<li class="chapter" data-level="9.1" data-path="function-operators.html"><a href="function-operators.html#behavioural-fos"><i class="fa fa-check"></i><b>9.1</b> Behavioural FOs</a></li>
<li class="chapter" data-level="9.2" data-path="function-operators.html"><a href="function-operators.html#output-fos"><i class="fa fa-check"></i><b>9.2</b> Output FOs</a></li>
<li class="chapter" data-level="9.3" data-path="function-operators.html"><a href="function-operators.html#input-fos"><i class="fa fa-check"></i><b>9.3</b> Input FOs</a></li>
<li class="chapter" data-level="9.4" data-path="function-operators.html"><a href="function-operators.html#combining-fos"><i class="fa fa-check"></i><b>9.4</b> Combining FOs</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="non-standard-evaluation.html"><a href="non-standard-evaluation.html"><i class="fa fa-check"></i><b>10</b> Non standard evaluation</a><ul>
<li class="chapter" data-level="10.1" data-path="non-standard-evaluation.html"><a href="non-standard-evaluation.html#capturing-expressions"><i class="fa fa-check"></i><b>10.1</b> Capturing expressions</a></li>
<li class="chapter" data-level="10.2" data-path="non-standard-evaluation.html"><a href="non-standard-evaluation.html#non-standard-evaluation-in-subset"><i class="fa fa-check"></i><b>10.2</b> Non standard evaluation in subset</a></li>
<li class="chapter" data-level="10.3" data-path="non-standard-evaluation.html"><a href="non-standard-evaluation.html#scoping-issues"><i class="fa fa-check"></i><b>10.3</b> Scoping issues</a></li>
<li class="chapter" data-level="10.4" data-path="non-standard-evaluation.html"><a href="non-standard-evaluation.html#calling-from-another-function"><i class="fa fa-check"></i><b>10.4</b> Calling from another function</a></li>
<li class="chapter" data-level="10.5" data-path="non-standard-evaluation.html"><a href="non-standard-evaluation.html#substitute"><i class="fa fa-check"></i><b>10.5</b> Substitute</a></li>
<li class="chapter" data-level="10.6" data-path="non-standard-evaluation.html"><a href="non-standard-evaluation.html#the-downsides-of-non-standard-evaluation"><i class="fa fa-check"></i><b>10.6</b> The downsides of non-standard evaluation</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="expressions.html"><a href="expressions.html"><i class="fa fa-check"></i><b>11</b> Expressions</a><ul>
<li class="chapter" data-level="11.1" data-path="expressions.html"><a href="expressions.html#structure-of-expressions"><i class="fa fa-check"></i><b>11.1</b> Structure of expressions</a></li>
<li class="chapter" data-level="11.2" data-path="expressions.html"><a href="expressions.html#names"><i class="fa fa-check"></i><b>11.2</b> Names</a></li>
<li class="chapter" data-level="11.3" data-path="expressions.html"><a href="expressions.html#calls"><i class="fa fa-check"></i><b>11.3</b> Calls</a></li>
<li class="chapter" data-level="11.4" data-path="expressions.html"><a href="expressions.html#capturing-the-current-call"><i class="fa fa-check"></i><b>11.4</b> Capturing the current call</a></li>
<li class="chapter" data-level="11.5" data-path="expressions.html"><a href="expressions.html#pairlists"><i class="fa fa-check"></i><b>11.5</b> Pairlists</a></li>
<li class="chapter" data-level="11.6" data-path="expressions.html"><a href="expressions.html#parsing-and-deparsing"><i class="fa fa-check"></i><b>11.6</b> Parsing and deparsing</a></li>
<li class="chapter" data-level="11.7" data-path="expressions.html"><a href="expressions.html#walking-the-ast-with-recursive-functions"><i class="fa fa-check"></i><b>11.7</b> Walking the AST with recursive functions</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="domain-specific-languages.html"><a href="domain-specific-languages.html"><i class="fa fa-check"></i><b>12</b> Domain specific languages</a><ul>
<li class="chapter" data-level="12.1" data-path="domain-specific-languages.html"><a href="domain-specific-languages.html#html"><i class="fa fa-check"></i><b>12.1</b> HTML</a></li>
<li class="chapter" data-level="12.2" data-path="domain-specific-languages.html"><a href="domain-specific-languages.html#latex"><i class="fa fa-check"></i><b>12.2</b> LaTeX</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="performance.html"><a href="performance.html"><i class="fa fa-check"></i><b>13</b> Performance</a><ul>
<li class="chapter" data-level="13.1" data-path="performance.html"><a href="performance.html#microbenchmarking"><i class="fa fa-check"></i><b>13.1</b> Microbenchmarking</a></li>
<li class="chapter" data-level="13.2" data-path="performance.html"><a href="performance.html#language-performance"><i class="fa fa-check"></i><b>13.2</b> Language performance</a></li>
<li class="chapter" data-level="13.3" data-path="performance.html"><a href="performance.html#implementations-performance"><i class="fa fa-check"></i><b>13.3</b> Implementations performance</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="profiling.html"><a href="profiling.html"><i class="fa fa-check"></i><b>14</b> Profiling</a><ul>
<li class="chapter" data-level="14.1" data-path="profiling.html"><a href="profiling.html#has-somebody-already-solved-the-problem"><i class="fa fa-check"></i><b>14.1</b> Has somebody already solved the problem?</a></li>
<li class="chapter" data-level="14.2" data-path="profiling.html"><a href="profiling.html#do-as-little-as-possible"><i class="fa fa-check"></i><b>14.2</b> Do as little as possible</a></li>
<li class="chapter" data-level="14.3" data-path="profiling.html"><a href="profiling.html#vectorise"><i class="fa fa-check"></i><b>14.3</b> Vectorise</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="memory.html"><a href="memory.html"><i class="fa fa-check"></i><b>15</b> Memory</a><ul>
<li class="chapter" data-level="15.1" data-path="memory.html"><a href="memory.html#object-size"><i class="fa fa-check"></i><b>15.1</b> Object size</a></li>
<li class="chapter" data-level="15.2" data-path="memory.html"><a href="memory.html#memory-profiling-with-lineprof"><i class="fa fa-check"></i><b>15.2</b> Memory profiling with lineprof</a></li>
<li class="chapter" data-level="15.3" data-path="memory.html"><a href="memory.html#modification-in-place"><i class="fa fa-check"></i><b>15.3</b> Modification in place</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="rcpp.html"><a href="rcpp.html"><i class="fa fa-check"></i><b>16</b> Rcpp</a><ul>
<li class="chapter" data-level="16.1" data-path="rcpp.html"><a href="rcpp.html#getting-started-with-c"><i class="fa fa-check"></i><b>16.1</b> Getting started with C++</a></li>
<li class="chapter" data-level="16.2" data-path="rcpp.html"><a href="rcpp.html#missing-values"><i class="fa fa-check"></i><b>16.2</b> Missing values</a></li>
<li class="chapter" data-level="16.3" data-path="rcpp.html"><a href="rcpp.html#the-stl"><i class="fa fa-check"></i><b>16.3</b> The STL</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="testchapter.html"><a href="testchapter.html"><i class="fa fa-check"></i><b>17</b> Testchapter</a></li>
<li class="chapter" data-level="18" data-path="s3-1.html"><a href="s3-1.html"><i class="fa fa-check"></i><b>18</b> S3</a><ul>
<li class="chapter" data-level="18.1" data-path="s3-1.html"><a href="s3-1.html#basics"><i class="fa fa-check"></i><b>18.1</b> Basics</a></li>
<li class="chapter" data-level="18.2" data-path="s3-1.html"><a href="s3-1.html#classes"><i class="fa fa-check"></i><b>18.2</b> Classes</a></li>
<li class="chapter" data-level="18.3" data-path="s3-1.html"><a href="s3-1.html#generics-and-methods"><i class="fa fa-check"></i><b>18.3</b> Generics and methods</a></li>
<li class="chapter" data-level="18.4" data-path="s3-1.html"><a href="s3-1.html#method-dispatch"><i class="fa fa-check"></i><b>18.4</b> Method dispatch</a></li>
<li class="chapter" data-level="18.5" data-path="s3-1.html"><a href="s3-1.html#inheritance"><i class="fa fa-check"></i><b>18.5</b> Inheritance</a></li>
<li class="chapter" data-level="18.6" data-path="s3-1.html"><a href="s3-1.html#dispatch-details"><i class="fa fa-check"></i><b>18.6</b> Dispatch details</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="s4-1.html"><a href="s4-1.html"><i class="fa fa-check"></i><b>19</b> S4</a><ul>
<li class="chapter" data-level="19.1" data-path="s4-1.html"><a href="s4-1.html#classes-1"><i class="fa fa-check"></i><b>19.1</b> Classes</a></li>
<li class="chapter" data-level="19.2" data-path="s4-1.html"><a href="s4-1.html#generics-and-methods-1"><i class="fa fa-check"></i><b>19.2</b> Generics and methods</a></li>
<li class="chapter" data-level="19.3" data-path="s4-1.html"><a href="s4-1.html#method-dispatch-1"><i class="fa fa-check"></i><b>19.3</b> Method dispatch</a></li>
<li class="chapter" data-level="19.4" data-path="s4-1.html"><a href="s4-1.html#s4-and-existing-code"><i class="fa fa-check"></i><b>19.4</b> S4 and existing code</a><ul>
<li class="chapter" data-level="19.4.1" data-path="s4-1.html"><a href="s4-1.html#exercises"><i class="fa fa-check"></i><b>19.4.1</b> Exercises</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced R Solutions</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="function-operators" class="section level1">
<h1><span class="header-section-number">9</span> Function operators</h1>
<div id="behavioural-fos" class="section level2">
<h2><span class="header-section-number">9.1</span> Behavioural FOs</h2>
<ol style="list-style-type: decimal">
<li><p><strong><span style="color:red">Q</span></strong>: Write a FO that logs a time stamp and message to a file every time a function is run.</p>
<p><strong><span style="color:green">A</span></strong>: Note that the example will create a file file in your current working directory:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">logger &lt;-<span class="st"> </span>function(f, filename){
  <span class="kw">force</span>(f)
  filename_tmp &lt;-<span class="st"> </span><span class="kw">paste</span>(filename, <span class="kw">basename</span>(<span class="kw">tempfile</span>()), <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)
  <span class="kw">write</span>(<span class="kw">paste</span>(<span class="st">&quot;created at:&quot;</span>, <span class="kw">Sys.time</span>()), filename_tmp, <span class="dt">append =</span> <span class="ot">TRUE</span>)
  function(..., <span class="dt">message =</span> <span class="st">&quot;you can add a message at each call&quot;</span>) {
    <span class="kw">write</span>(<span class="kw">paste0</span>(<span class="st">&quot;used at: &quot;</span>, <span class="kw">Sys.time</span>(), <span class="st">&quot;, &quot;</span>, message), filename_tmp, <span class="dt">append =</span> <span class="ot">TRUE</span>)
    <span class="kw">f</span>(...)
  }
}

<span class="co"># the following line creates a file, which name starts with &quot;mean_log_&quot;</span>
mean2 &lt;-<span class="st"> </span><span class="kw">logger</span>(mean, <span class="st">&quot;mean_log&quot;</span>) 
<span class="kw">mean2</span>(<span class="dv">1</span>:<span class="dv">4</span>, <span class="dt">message =</span> <span class="st">&quot;first time&quot;</span>) 
<span class="kw">mean2</span>(<span class="dv">1</span>:<span class="dv">4</span>, <span class="dt">message =</span> <span class="st">&quot;second_time&quot;</span>)</code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: What does the following function do? What would be a good name for it?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span>function(g) {
  <span class="kw">force</span>(g)
  result &lt;-<span class="st"> </span><span class="ot">NULL</span>
  function(...) {
    if (<span class="kw">is.null</span>(result)) {
      result &lt;&lt;-<span class="st"> </span><span class="kw">g</span>(...)
    }
    result
  }
}
runif2 &lt;-<span class="st"> </span><span class="kw">f</span>(runif)
<span class="kw">runif2</span>(<span class="dv">5</span>)
<span class="co">#&gt; [1] 0.1090973 0.8933546 0.6849637 0.7362727 0.8324138</span>
<span class="kw">runif2</span>(<span class="dv">10</span>)
<span class="co">#&gt; [1] 0.1090973 0.8933546 0.6849637 0.7362727 0.8324138</span></code></pre></div>
<p><strong><span style="color:green">A</span></strong>: It returns a new version of the inputfunction. That version will always return the result of it’s first run (in case this not <code>NULL</code>), no matter how the input changes. Good names could be <code>first_run()</code> or <code>initial_return()</code>.</p></li>
<li><p><strong><span style="color:red">Q</span></strong>: Modify <code>delay_by()</code> so that instead of delaying by a fixed amount of time, it ensures that a certain amount of time has elapsed since the function was last called. That is, if you called <code>g &lt;- delay_by(1, f); g(); Sys.sleep(2); g()</code> there shouldn’t be an extra delay.</p>
<p><strong><span style="color:green">A</span></strong>: We can do this with three little tricks (and the help of 42):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">delay_by_v2 &lt;-<span class="st"> </span>function(delay, f) {
  <span class="kw">force</span>(f)
  <span class="co"># we initialise the timestamp for the last run. We set a specific default value,</span>
  <span class="co"># to ensure that the first run of the returned function will never be delayed</span>
  last_runtime &lt;-<span class="st"> </span><span class="kw">Sys.time</span>() -<span class="st"> </span>(delay +<span class="st"> </span><span class="dv">42</span>)
  function(...) {
    <span class="co"># we continually check if enough time passed with an (empty) while statement.</span>
    while (<span class="kw">Sys.time</span>() &lt;<span class="st"> </span>last_runtime +<span class="st"> </span>delay) {}
    <span class="co"># we override the start for the next waiting interval.</span>
    <span class="co"># Note that this is done on exit (after the function is evaluated)</span>
    <span class="kw">on.exit</span>(last_runtime &lt;&lt;-<span class="st"> </span><span class="kw">Sys.time</span>()) 
    <span class="kw">return</span>(<span class="kw">f</span>(...))
  }
}</code></pre></div>
<p>Alternatively to the empty while statement we could have used <code>Sys.sleep()</code>. I would not recommend this solution, since <code>?Sys.sleep</code> indicates that <code>Sys.sleep()</code> might have some overhead and seems not to be as exact as we need.</p></li>
<li><p><strong><span style="color:red">Q</span></strong>: Write <code>wait_until()</code> which delays execution until a specific time.</p>
<p><strong><span style="color:green">A</span></strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wait_until &lt;-<span class="st"> </span>function(time, f) {
  <span class="kw">force</span>(f)
  function(...) {
    while (<span class="kw">Sys.time</span>() &lt;<span class="st"> </span>time) {}
    <span class="kw">return</span>(<span class="kw">f</span>(...))
  }
}

<span class="co"># a little test</span>
ptm &lt;-<span class="st"> </span><span class="kw">proc.time</span>()
m &lt;-<span class="st"> </span><span class="kw">wait_until</span>(<span class="kw">Sys.time</span>() +<span class="st"> </span><span class="dv">10</span>, mean)
<span class="kw">m</span>(<span class="dv">1</span>:<span class="dv">3</span>)
<span class="kw">proc.time</span>() -<span class="st"> </span>ptm</code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: There are three places we could have added a memoise call: why did we choose the one we did?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">download &lt;-<span class="st"> </span><span class="kw">memoise</span>(<span class="kw">dot_every</span>(<span class="dv">10</span>, <span class="kw">delay_by</span>(<span class="dv">1</span>, download_file)))
download &lt;-<span class="st"> </span><span class="kw">dot_every</span>(<span class="dv">10</span>, <span class="kw">memoise</span>(<span class="kw">delay_by</span>(<span class="dv">1</span>, download_file)))
download &lt;-<span class="st"> </span><span class="kw">dot_every</span>(<span class="dv">10</span>, <span class="kw">delay_by</span>(<span class="dv">1</span>, <span class="kw">memoise</span>(download_file)))</code></pre></div>
<p><strong><span style="color:green">A</span></strong>: The second was chosen. It’s easy to see why, if we eliminate the other two options:</p>
<ul>
<li><p>The first version only prints a dot at every tenth <code>download()</code> call with a new input. This is because <code>dot_every()</code> is inside of <code>memoise()</code> and the counter created by <code>dot_every()</code> is not “activated” if the input is known.</p></li>
<li><p>The third version takes one second for every call. Even if we already know the result and don’t download anything again.</p></li>
</ul></li>
<li><p><strong><span style="color:red">Q</span></strong>: Why is the <code>remember()</code> function inefficient? How could you implement it in more efficient way?</p></li>
<li><p><strong><span style="color:red">Q</span></strong>: Why does the following code, from <a href="http://stackoverflow.com/questions/8440675">stackoverflow</a>, not do what you expect?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># return a linear function with slope a and intercept b.</span>
f &lt;-<span class="st"> </span>function(a, b) function(x) a *<span class="st"> </span>x +<span class="st"> </span>b

<span class="co"># create a list of functions with different parameters.</span>
fs &lt;-<span class="st"> </span><span class="kw">Map</span>(f, <span class="dt">a =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">b =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))

fs[[<span class="dv">1</span>]](<span class="dv">3</span>)
<span class="co">#&gt; [1] 0</span>
<span class="co"># should return 0 * 3 + 0 = 0</span></code></pre></div>
<p>How can you modify <code>f</code> so that it works correctly?</p>
<p><strong><span style="color:green">A</span></strong>: You can read in the <a href="http://stackoverflow.com/questions/8440675">stackoverflow</a> link that the question arose, because the original return of <code>fs[[1]](3)</code> was <code>4</code>, which is due to lazy evaluation and could be solved by two users via <code>force()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span>function(a, b) {<span class="kw">force</span>(a); <span class="kw">force</span>(b); function(x) a *<span class="st"> </span>x +<span class="st"> </span>b}</code></pre></div>
<p>However you can see in the result within the question that <strong>R</strong>’s behaviour was changed in this case and as Jan Kislinger points out on <a href="https://twitter.com/JanKislinger/status/794433891486547968">twitter</a>:</p>
<blockquote>
<p>The real question should be: “How did they modify #rstats so that it works correctly?” otherwise it’s a tricky question :D</p>
</blockquote>
<p>Note that the same issue appears in the <a href="http://adv-r.had.co.nz/Function-operators.html#behavioural-fos">textbook</a>:</p>
<blockquote>
<p>In the following example, we take a list of functions and delay each one. But when we try to evaluate the mean, we get the sum instead.</p>
</blockquote>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">funs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">mean =</span> mean, <span class="dt">sum =</span> sum)
funs_m &lt;-<span class="st"> </span><span class="kw">lapply</span>(funs, delay_by, <span class="dt">delay =</span> <span class="fl">0.1</span>)

funs_m$<span class="kw">mean</span>(<span class="dv">1</span>:<span class="dv">10</span>)
<span class="co">#&gt; [1] 5.5</span></code></pre></div>
<p>Which (as one can see) is not true anymore…actually it changed in R version <a href="https://stat.ethz.ch/pipermail/r-announce/2015/000583.html"><strong>3.2</strong></a>:</p>
<blockquote>
<p>Higher order functions such as the apply functions and Reduce() now force arguments to the functions they apply in order to eliminate undesirable interactions between lazy evaluation and variable capture in closures. This resolves PR#16093.</p>
</blockquote>
<p>For further interested: <a href="https://bugs.r-project.org/bugzilla3/show_bug.cgi?id=16093#c1">PR#16093</a> will lead you to the subject “iterated lapply” within the <a href="https://stat.ethz.ch/pipermail/r-devel/2015-March/subject.html#start">R-devel Archives</a>. Note that the behaviour in for loops is still as “the old <code>lapply()</code>” behaviour.</p></li>
</ol>
</div>
<div id="output-fos" class="section level2">
<h2><span class="header-section-number">9.2</span> Output FOs</h2>
<ol style="list-style-type: decimal">
<li><p><strong><span style="color:red">Q</span></strong>: Create a <code>negative()</code> FO that flips the sign of the output of the function to which it is applied.</p>
<p><strong><span style="color:green">A</span></strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">negative &lt;-<span class="st"> </span>function(f){
  <span class="kw">force</span>(f)
  function(...){
    -<span class="kw">f</span>(...)
  }
}</code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: The <code>evaluate</code> package makes it easy to capture all the outputs (results, text, messages, warnings, errors, and plots) from an expression. Create a function like <code>capture_it()</code> that also captures the warnings and errors generated by a function.</p>
<p><strong><span style="color:green">A</span></strong>: One way is just to capture the output of <code>tryCatch()</code> with identity handlers for errors and warnings:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">capture_trials &lt;-<span class="st"> </span>function(f){
  <span class="kw">force</span>(f)
  function(...){
    <span class="kw">capture.output</span>(<span class="kw">tryCatch</span>(<span class="kw">f</span>(...),
                            <span class="dt">error =</span> function(e) e,
                            <span class="dt">warning =</span> function(w) w)
    )
  }
}

<span class="co"># we test the behaviour</span>
log_t &lt;-<span class="st"> </span><span class="kw">capture_trials</span>(log)
elements &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dv">1</span>:<span class="dv">10</span>, <span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">10</span>), <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>), letters)
results &lt;-<span class="st"> </span><span class="kw">lapply</span>(elements, function(x) <span class="kw">log_t</span>(x))
results
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] &quot; [1] 0.0000000 0.6931472 1.0986123 1.3862944 1.6094379 1.7917595 1.9459101&quot;</span>
<span class="co">#&gt; [2] &quot; [8] 2.0794415 2.1972246 2.3025851&quot;                                        </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] &quot;&lt;simpleWarning in f(...): NaNs produced&gt;&quot;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] &quot;[1]    0 -Inf&quot;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; [1] &quot;&lt;simpleError in f(...): non-numeric argument to mathematical function&gt;&quot;</span>

<span class="co"># further</span>
<span class="co"># results_detailed &lt;- lapply(elements, function(x) lapply(x, function(y))log2(x))</span>
<span class="co"># results_detailed</span></code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: Create a FO that tracks files created or deleted in the working directory (Hint: use <code>dir()</code> and <code>setdiff()</code>.) What other global effects of functions might you want to track?</p>
<p><strong><span style="color:green">A</span></strong>: We start with a short version to show the idea:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">track_dir &lt;-<span class="st"> </span>function(f){
  <span class="kw">force</span>(f)
  function(...){
    dir_old &lt;-<span class="st"> </span><span class="kw">dir</span>()
    <span class="kw">on.exit</span>(if(!<span class="kw">setequal</span>(<span class="kw">dir</span>(), dir_old)){
      <span class="kw">message</span>(<span class="st">&quot;files in your working directory were deleted or added by this function&quot;</span>)})
    <span class="kw">f</span>(...)
  }
}

<span class="co"># the following test will create the file &quot;delete_me&quot; in your working directory</span>
td &lt;-<span class="st"> </span><span class="kw">track_dir</span>(dir.create)
<span class="kw">td</span>(<span class="st">&quot;delete_me&quot;</span>)</code></pre></div>
<p>Of course we can provide more information on the type of changes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">track_dir &lt;-<span class="st"> </span>function(f){
  <span class="kw">force</span>(f)
  function(...){
    dir_old &lt;-<span class="st"> </span><span class="kw">dir</span>()

    <span class="kw">on.exit</span>(if(!<span class="kw">setequal</span>(<span class="kw">dir</span>(), dir_old)){
      <span class="kw">message</span>(<span class="st">&quot;Files in your working directory were deleted or added by this</span>
<span class="st">              function.&quot;</span>)}, <span class="dt">add =</span> <span class="ot">TRUE</span>)
    <span class="kw">on.exit</span>(if(<span class="kw">length</span>(<span class="kw">setdiff</span>(dir_old, <span class="kw">dir</span>()) !=<span class="st"> </span><span class="dv">0</span>)){
      <span class="kw">message</span>(<span class="kw">paste0</span>(<span class="st">&quot;The following files were deleted: &quot;</span>,
                     <span class="kw">paste</span>(<span class="kw">setdiff</span>(dir_old, <span class="kw">dir</span>()), <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>)
                     ))}, <span class="dt">add =</span> <span class="ot">TRUE</span>)
    <span class="kw">on.exit</span>(if(<span class="kw">length</span>(<span class="kw">setdiff</span>(<span class="kw">dir</span>(), dir_old) !=<span class="st"> </span><span class="dv">0</span>)){
      <span class="kw">message</span>(<span class="kw">paste0</span>(<span class="st">&quot;The following files were added: &quot;</span>, 
                     <span class="kw">paste</span>(<span class="kw">setdiff</span>(<span class="kw">dir</span>(), dir_old), <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>)
                     ))}, <span class="dt">add =</span> <span class="ot">TRUE</span>)

    <span class="kw">f</span>(...)
  }
}

<span class="co"># the following test will again create two files in your working directory</span>
td &lt;-<span class="st"> </span><span class="kw">track_dir</span>(sapply)
<span class="kw">td</span>(<span class="kw">c</span>(<span class="st">&quot;delete_me&quot;</span>, <span class="st">&quot;me_too&quot;</span>), dir.create)</code></pre></div>
<p>Other global effects that might be worth tracking include changes regarding:</p>
<ul>
<li>the search path and/or introduced <code>conflicts()</code></li>
<li><code>options()</code> and <code>par()</code> which modify global settings</li>
<li>the path of the working directory</li>
<li>environment variables</li>
<li>the locale.</li>
</ul></li>
</ol>
</div>
<div id="input-fos" class="section level2">
<h2><span class="header-section-number">9.3</span> Input FOs</h2>
<ol style="list-style-type: decimal">
<li><p><strong><span style="color:red">Q</span></strong>: Our previous <code>download()</code> function only downloads a single file. How can you use <code>partial()</code> and <code>lapply()</code> to create a function that downloads multiple files at once? What are the pros and cons of using <code>partial()</code> vs. writing a function by hand?</p></li>
<li><p><strong><span style="color:red">Q</span></strong>: Read the source code for <code>plyr::colwise()</code>. How does the code work? What are <code>colwise()</code>’s three main tasks? How could you make <code>colwise()</code> simpler by implementing each task as a function operator? (Hint: think about <code>partial()</code>.)</p>
<p><strong><span style="color:orange">A</span></strong>: We describe how it works by commenting the source code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">function (.fun, <span class="dt">.cols =</span> true, ...) 
  {
  <span class="co"># We check if .cols is not a function, since it is possible to supply a</span>
  <span class="co"># predicate function.</span>
  <span class="co"># if so, the .cols arguments will be &quot;quoted&quot;, and filter() will </span>
  <span class="co"># be a function that checks and evaluates these .cols within its other argument</span>
  if (!<span class="kw">is.function</span>(.cols)) {
    .cols &lt;-<span class="st"> </span><span class="kw">as.quoted</span>(.cols)
    filter &lt;-<span class="st"> </span>function(df) <span class="kw">eval.quoted</span>(.cols, df)
  }
  <span class="co"># otherwise, filter will be be Filter(), which applies the function </span>
  <span class="co"># in .cols to every element of its other argument</span>
  else {
    filter &lt;-<span class="st"> </span>function(df) <span class="kw">Filter</span>(.cols, df)
  }
  <span class="co"># the ... arguments are caught in the list dots</span>
  dots &lt;-<span class="st"> </span><span class="kw">list</span>(...)
  <span class="co"># a function is created, which will also be the return value.</span>
  <span class="co"># it checks if its input is a data frame</span>
  function(df, ...) {
    <span class="kw">stopifnot</span>(<span class="kw">is.data.frame</span>(df))
    <span class="co"># if df is split (in &quot;plyr&quot; speaking), this will be taken into account...</span>
    df &lt;-<span class="st"> </span><span class="kw">strip_splits</span>(df)
    <span class="co"># now the columns of the data frame are chosen, depending on the input of .cols</span>
    <span class="co"># this can chosen directly, via a predicate function, or all columns (default)</span>
    filtered &lt;-<span class="st"> </span><span class="kw">filter</span>(df)
    <span class="co"># if this means, that no columns are selected, an empty data frame will be returned</span>
    if (<span class="kw">length</span>(filtered) ==<span class="st"> </span><span class="dv">0</span>) 
      <span class="kw">return</span>(<span class="kw">data.frame</span>())
    <span class="co"># otherwise lapply will be called on all filtered columns, with </span>
    <span class="co"># the .fun argument, which has to be provided by the user, and some other</span>
    <span class="co"># arguments provided by the user, when calling the function (...) and</span>
    <span class="co"># when defining the function (dots)</span>
    out &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;lapply&quot;</span>, <span class="kw">c</span>(<span class="kw">list</span>(filtered, .fun, ...), 
                           dots))
    <span class="co"># the output will be named and converted from list into a data frame again</span>
    <span class="kw">names</span>(out) &lt;-<span class="st"> </span><span class="kw">names</span>(filtered)
    <span class="kw">quickdf</span>(out)
  }
}

&lt;environment:<span class="st"> </span>namespace:plyr&gt;</code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: Write FOs that convert a function to return a matrix instead of a data frame, or a data frame instead of a matrix. If you understand S3, call them <code>as.data.frame.function()</code> and <code>as.matrix.function()</code>.</p>
<p><strong><span style="color:green">A</span></strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">as.matrix.function &lt;-<span class="st"> </span>function(f){
  <span class="kw">force</span>(f)
  function(...){
    <span class="kw">as.matrix</span>(<span class="kw">f</span>(...))
  }
}

as.data.frame.function &lt;-<span class="st"> </span>function(f){
  <span class="kw">force</span>(f)
  function(...){
    <span class="kw">as.data.frame</span>(<span class="kw">f</span>(...))
  }
}</code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: You’ve seen five functions that modify a function to change its output from one form to another. What are they? Draw a table of the various combinations of types of outputs: what should go in the rows and what should go in the columns? What function operators might you want to write to fill in the missing cells? Come up with example use cases.</p></li>
<li><p><strong><span style="color:red">Q</span></strong>: Look at all the examples of using an anonymous function to partially apply a function in this and the previous chapter. Replace the anonymous function with <code>partial()</code>. What do you think of the result? Is it easier or harder to read?</p>
<p><strong><span style="color:green">A</span></strong>: The results are easy to read. Especially the <code>Map()</code> examples profit in readability:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(pryr)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;pryr&#39;</span>
<span class="co">#&gt; The following object is masked _by_ &#39;.GlobalEnv&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     f</span>
## From Functionals
<span class="co"># 1</span>
trims &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>)
x &lt;-<span class="st"> </span><span class="kw">rcauchy</span>(<span class="dv">1000</span>)
<span class="kw">unlist</span>(<span class="kw">lapply</span>(trims, function(trim) <span class="kw">mean</span>(x, <span class="dt">trim =</span> trim)))
<span class="co">#&gt; [1] -2.14471243  0.09442859  0.07433510  0.07655498</span>
<span class="kw">unlist</span>(<span class="kw">lapply</span>(trims, <span class="kw">partial</span>(mean, x)))
<span class="co">#&gt; [1] -2.14471243  0.09442859  0.07433510  0.07655498</span>

<span class="co"># 2</span>
xs &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">5</span>, <span class="kw">runif</span>(<span class="dv">10</span>), <span class="dt">simplify =</span> <span class="ot">FALSE</span>)
ws &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">5</span>, <span class="kw">rpois</span>(<span class="dv">10</span>, <span class="dv">5</span>) +<span class="st"> </span><span class="dv">1</span>, <span class="dt">simplify =</span> <span class="ot">FALSE</span>)
<span class="kw">unlist</span>(<span class="kw">Map</span>(function(x, w) <span class="kw">weighted.mean</span>(x, w, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), xs, ws))
<span class="co">#&gt; [1] 0.5024602 0.4685572 0.5303112 0.5839586 0.6122118</span>
<span class="kw">unlist</span>(<span class="kw">Map</span>(<span class="kw">partial</span>(weighted.mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), xs, ws))
<span class="co">#&gt; [1] 0.5024602 0.4685572 0.5303112 0.5839586 0.6122118</span>

<span class="co"># 3</span>
add &lt;-<span class="st"> </span>function(x, y, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>) {
  if (na.rm &amp;&amp;<span class="st"> </span>(<span class="kw">is.na</span>(x) ||<span class="st"> </span><span class="kw">is.na</span>(y))) <span class="kw">rm_na</span>(x, y, <span class="dv">0</span>) else x +<span class="st"> </span>y
}

r_add &lt;-<span class="st"> </span>function(xs, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) {
  <span class="kw">Reduce</span>(function(x, y) <span class="kw">add</span>(x, y, <span class="dt">na.rm =</span> na.rm), xs)
}

r_add_compact &lt;-<span class="st"> </span>function(xs, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) {
  <span class="kw">Reduce</span>(<span class="kw">partial</span>(add, <span class="dt">na.rm =</span> na.rm), xs)
}

<span class="kw">r_add</span>(<span class="dv">1</span>:<span class="dv">4</span>)
<span class="co">#&gt; [1] 10</span>
<span class="kw">r_add_compact</span>(<span class="dv">1</span>:<span class="dv">4</span>)
<span class="co">#&gt; [1] 10</span>

<span class="co"># 4</span>
v_add1 &lt;-<span class="st"> </span>function(x, y, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>) {
  <span class="kw">stopifnot</span>(<span class="kw">length</span>(x) ==<span class="st"> </span><span class="kw">length</span>(y), <span class="kw">is.numeric</span>(x), <span class="kw">is.numeric</span>(y))
  if (<span class="kw">length</span>(x) ==<span class="st"> </span><span class="dv">0</span>) <span class="kw">return</span>(<span class="kw">numeric</span>())
  <span class="kw">simplify2array</span>(
    <span class="kw">Map</span>(function(x, y) <span class="kw">add</span>(x, y, <span class="dt">na.rm =</span> na.rm), x, y)
  )
}

v_add1_compact &lt;-<span class="st"> </span>function(x, y, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>) {
  <span class="kw">stopifnot</span>(<span class="kw">length</span>(x) ==<span class="st"> </span><span class="kw">length</span>(y), <span class="kw">is.numeric</span>(x), <span class="kw">is.numeric</span>(y))
  if (<span class="kw">length</span>(x) ==<span class="st"> </span><span class="dv">0</span>) <span class="kw">return</span>(<span class="kw">numeric</span>())
  <span class="kw">simplify2array</span>(
    <span class="kw">Map</span>(<span class="kw">partial</span>(add, <span class="dt">na.rm =</span> na.rm), x, y)
  )
}

<span class="kw">v_add1</span>(<span class="dv">1</span>:<span class="dv">3</span>, <span class="dv">2</span>:<span class="dv">4</span>)
<span class="co">#&gt; [1] 3 5 7</span>
<span class="kw">v_add1_compact</span>(<span class="dv">1</span>:<span class="dv">3</span>, <span class="dv">2</span>:<span class="dv">4</span>)
<span class="co">#&gt; [1] 3 5 7</span>

<span class="co"># 5</span>
c_add &lt;-<span class="st"> </span>function(xs, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>) {
  <span class="kw">Reduce</span>(function(x, y) <span class="kw">add</span>(x, y, <span class="dt">na.rm =</span> na.rm), xs,
         <span class="dt">accumulate =</span> <span class="ot">TRUE</span>)
}

c_add_compact &lt;-<span class="st"> </span>function(xs, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>) {
  <span class="kw">Reduce</span>(<span class="kw">partial</span>(add, <span class="dt">na.rm =</span> na.rm), xs,
         <span class="dt">accumulate =</span> <span class="ot">TRUE</span>)
}

<span class="kw">c_add</span>(<span class="dv">1</span>:<span class="dv">3</span>)
<span class="co">#&gt; [1] 1 3 6</span>
<span class="kw">c_add_compact</span>(<span class="dv">1</span>:<span class="dv">3</span>)
<span class="co">#&gt; [1] 1 3 6</span>

## From Function operators
<span class="co"># 6</span>
f &lt;-<span class="st"> </span>function(x) x ^<span class="st"> </span><span class="dv">2</span>
<span class="kw">partial</span>(f)
<span class="co">#&gt; function (...) </span>
<span class="co">#&gt; f(...)</span>

<span class="co"># 7</span>
<span class="co"># Map(function(x, y) f(x, y, zs), xs, ys)</span>
<span class="co"># Map(partial(f, zs = zs), xs, yz)</span>

<span class="co"># 8</span>
<span class="co"># f &lt;- function(a) g(a, b = 1)</span>
<span class="co"># f &lt;- partial(g, b = 1)</span>

<span class="co"># 9</span>
compact &lt;-<span class="st"> </span>function(x) <span class="kw">Filter</span>(<span class="kw">Negate</span>(is.null), x)
compact &lt;-<span class="st"> </span><span class="kw">partial</span>(Filter, <span class="kw">Negate</span>(is.null))

<span class="co"># 10</span>
<span class="co"># Map(function(x, y) f(x, y, zs), xs, ys)</span>
<span class="co"># Map(partial(f, zs = zs), xs, ys)</span>

<span class="co"># 11</span>
funs2 &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">sum =</span> function(...) <span class="kw">sum</span>(..., <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
  <span class="dt">mean =</span> function(...) <span class="kw">mean</span>(..., <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
  <span class="dt">median =</span> function(...) <span class="kw">median</span>(..., <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
)

funs2 &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">sum =</span> <span class="kw">partial</span>(sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
  <span class="dt">mean =</span> <span class="kw">partial</span>(mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
  <span class="dt">median =</span> <span class="kw">partial</span>(median, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
)</code></pre></div></li>
</ol>
</div>
<div id="combining-fos" class="section level2">
<h2><span class="header-section-number">9.4</span> Combining FOs</h2>
<ol style="list-style-type: decimal">
<li><p><strong><span style="color:red">Q</span></strong>: Implement your own version of <code>compose()</code> using <code>Reduce</code> and <code>%o%</code>. For bonus points, do it without calling <code>function</code>.</p>
<p><strong><span style="color:green">A</span></strong>: We use the definition from the textbook:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">compose &lt;-<span class="st"> </span>function(f, g) {
  function(...) <span class="kw">f</span>(<span class="kw">g</span>(...))
}

<span class="st">&quot;%o%&quot;</span> &lt;-<span class="st"> </span>compose</code></pre></div>
<p>And then we build two versions. One via an anonymous function and one via <code>partial()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">compose_red &lt;-<span class="st"> </span>function(fs) {
  <span class="kw">Reduce</span>(function(f, g) function(...) <span class="kw">f</span>(<span class="kw">g</span>(...)), fs)
}
<span class="kw">compose_red</span>(<span class="kw">c</span>(mean, length, unique))(<span class="dv">1</span>:<span class="dv">10</span>)
<span class="co">#&gt; [1] 10</span>

compose_red_bonus &lt;-<span class="st"> </span>function(fs) {
  <span class="kw">Reduce</span>(<span class="kw">partial</span>(<span class="kw">partial</span>(<span class="st">`</span><span class="dt">%o%</span><span class="st">`</span>)), fs)
}
<span class="kw">compose_red_bonus</span>(<span class="kw">c</span>(mean, length, unique))(<span class="dv">1</span>:<span class="dv">10</span>)
<span class="co">#&gt; [1] 10</span></code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: Extend <code>and()</code> and <code>or()</code> to deal with any number of input functions. Can you do it with <code>Reduce()</code>? Can you keep them lazy (e.g., for <code>and()</code>, the function returns once it sees the first <code>FALSE</code>)?</p>
<p><strong><span style="color:green">A</span></strong>: We use <code>and()</code> and <code>or()</code> as defined in the textbook. They are lazy, since they are build up on <code>&amp;&amp;</code> and <code>||</code>. Also their reduced versions stay lazy, as we will show at the end of the code</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">and &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">f1</span>(...) &amp;&amp;<span class="st"> </span><span class="kw">f2</span>(...)
  }
}

and_red &lt;-<span class="st"> </span>function(fs){
  <span class="kw">Reduce</span>(function(f, g) <span class="kw">and</span>(f, g), fs)
}

or &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">f1</span>(...) ||<span class="st"> </span><span class="kw">f2</span>(...)
  }
}

or_red &lt;-<span class="st"> </span>function(fs){
  <span class="kw">Reduce</span>(function(f, g) <span class="kw">or</span>(f, g), fs)
}

<span class="co"># Errors before the first TRUE will be returned</span>
<span class="kw">tryCatch</span>(
  <span class="kw">or_red</span>(<span class="kw">c</span>(is.logical, is.logical, stop, is.character))(<span class="st">&quot;a&quot;</span>), 
  <span class="dt">error =</span> function(e) e
)
<span class="co">#&gt; &lt;simpleError in f1(...): a&gt;</span>

<span class="co"># Errors after the first TRUE won&#39;t be returned</span>
<span class="kw">or_red</span>(<span class="kw">c</span>(is.logical, is.logical, is.character, stop))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] TRUE</span></code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: Implement the <code>xor()</code> binary operator. Implement it using the existing <code>xor()</code> function. Implement it as a combination of <code>and()</code> and <code>or()</code>. What are the advantages and disadvantages of each approach? Also think about what you’ll call the resulting function to avoid a clash with the existing <code>xor()</code> function, and how you might change the names of <code>and()</code>, <code>not()</code>, and <code>or()</code> to keep them consistent.</p>
<p><strong><span style="color:orange">A</span></strong>: Both versions are implemented straight forward, as also the reduced versions. However, the parallel versions need a little bit more care:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xor_fb1 &lt;-<span class="st"> </span>function(f1, f2){
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...){
    <span class="kw">xor</span>(<span class="kw">f1</span>(...), <span class="kw">f2</span>(...)) 
  }
}

xor_fb2 &lt;-<span class="st"> </span>function(f1, f2){
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...){
    <span class="kw">or</span>(f1, f2)(...) &amp;&amp;<span class="st"> </span>!(<span class="kw">and</span>(f1, f2)(...))
  }
}

<span class="co"># binary combination</span>
<span class="kw">xor_fb1</span>(is.logical, is.character)(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] TRUE</span>
<span class="kw">xor_fb2</span>(is.logical, is.character)(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] TRUE</span>

<span class="co"># parallel combination (results in an error)</span>
<span class="kw">xor_fb1</span>(<span class="kw">c</span>(is.logical, is.character), <span class="kw">c</span>(is.logical, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; Error in f1(...): could not find function &quot;f1&quot;</span>
<span class="kw">xor_fb2</span>(<span class="kw">c</span>(is.logical, is.character), <span class="kw">c</span>(is.logical, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; Error in f1(...): could not find function &quot;f1&quot;</span>

<span class="co"># reduced combination (results in an error)</span>
<span class="kw">xor_fb1</span>(<span class="kw">c</span>(is.logical, is.character, is.logical, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; Error in force(f2): argument &quot;f2&quot; is missing, with no default</span>
<span class="kw">xor_fb2</span>(<span class="kw">c</span>(is.logical, is.character, is.logical, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; Error in force(f2): argument &quot;f2&quot; is missing, with no default</span>

### Reduced version
xor_fb1_red &lt;-<span class="st"> </span>function(fs){
  <span class="kw">Reduce</span>(function(f, g) <span class="kw">xor_fb1</span>(f, g), fs)
}

xor_fb2_red &lt;-<span class="st"> </span>function(fs){
  <span class="kw">Reduce</span>(function(f, g) <span class="kw">xor_fb2</span>(f, g), fs)
}

<span class="co"># should return TRUE</span>
<span class="kw">xor_fb1_red</span>(<span class="kw">c</span>(is.logical, is.character, is.logical, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] FALSE</span>
<span class="kw">xor_fb2_red</span>(<span class="kw">c</span>(is.logical, is.character, is.logical, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] FALSE</span>

<span class="co"># should return FALSE</span>
<span class="kw">xor_fb1_red</span>(<span class="kw">c</span>(is.logical, is.logical, is.character, is.logical))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] TRUE</span>
<span class="kw">xor_fb2_red</span>(<span class="kw">c</span>(is.logical, is.logical, is.character, is.logical))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] TRUE</span>

<span class="co"># should return FALSE</span>
<span class="kw">xor_fb1_red</span>(<span class="kw">c</span>(is.logical, is.logical, is.character, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] FALSE</span>
<span class="kw">xor_fb2_red</span>(<span class="kw">c</span>(is.logical, is.logical, is.character, is.character))(<span class="st">&quot;a&quot;</span>)
<span class="co">#&gt; [1] FALSE</span></code></pre></div></li>
<li><p><strong><span style="color:red">Q</span></strong>: Above, we implemented boolean algebra for functions that return a logical function. Implement elementary algebra (<code>plus()</code>, <code>minus()</code>, <code>multiply()</code>, <code>divide()</code>, <code>exponentiate()</code>, <code>log()</code>) for functions that return numeric vectors.</p>
<p><strong><span style="color:green">A</span></strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plus &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">f1</span>(...) +<span class="st"> </span><span class="kw">f2</span>(...)
  }
}

minus &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">f1</span>(...) -<span class="st"> </span><span class="kw">f2</span>(...)
  }
}

multiply &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">f1</span>(...) *<span class="st"> </span><span class="kw">f2</span>(...)
  }
}

divide &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">f1</span>(...) /<span class="st"> </span><span class="kw">f2</span>(...)
  }
}

exponentiate &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">f1</span>(...) ^<span class="st"> </span><span class="kw">f2</span>(...)
  }
}

<span class="co"># we rename log to log_ since log() already exists</span>
log_ &lt;-<span class="st"> </span>function(f1, f2) {
  <span class="kw">force</span>(f1); <span class="kw">force</span>(f2)
  function(...) {
    <span class="kw">log</span>(<span class="kw">f1</span>(...), <span class="kw">f2</span>(...))
  }
}

<span class="co"># Test</span>
mns &lt;-<span class="st"> </span><span class="kw">minus</span>(mean, function(x) x^<span class="dv">2</span>)
<span class="kw">mns</span>(<span class="dv">1</span>:<span class="dv">5</span>)</code></pre></div></li>
</ol>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="functionals.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="non-standard-evaluation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Tazinho/Advanced-R-Solutions/edit/master/09-Function_operators.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
